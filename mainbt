import asyncio
import logging
import sqlite3
from aiogram import Bot, Dispatcher, types
from aiogram.types import ReplyKeyboardMarkup, KeyboardButton, InlineKeyboardMarkup, InlineKeyboardButton

# =================================================
# 8769319387:AAEPvIDWSkxfjzNdakjLHr
7Pqrsjhctxxgw
API_TOKEN = "8769319387:AAEPvIDWSkxfjzNdakjLHr
7Pqrsjhctxxgw"
# =================================================

logging.basicConfig(level=logging.INFO)
bot = Bot(token=API_TOKEN)
dp = Dispatcher()

# =======================
# –ë–ê–ó–ê –î–ê–ù–ò–•
# =======================
conn = sqlite3.connect("users.db")
cursor = conn.cursor()

cursor.execute("""
CREATE TABLE IF NOT EXISTS users (
    user_id INTEGER PRIMARY KEY,
    balance REAL DEFAULT 0,
    daily_earned REAL DEFAULT 0,
    referrals INTEGER DEFAULT 0
)
""")
conn.commit()

# =======================
# –ö–õ–ê–í–Ü–ê–¢–£–†–ò
# =======================
menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")],
        [KeyboardButton(text="–í—ã–≤–µ—Å—Ç–∏")]
    ],
    resize_keyboard=True
)

earn_menu = ReplyKeyboardMarkup(
    keyboard=[
        [KeyboardButton(text="–ö–ª–∏–∫")],
        [KeyboardButton(text="–ù–∞–∑–∞–¥")]
    ],
    resize_keyboard=True
)

# =======================
# –°–¢–ê–†–¢ / –†–ï–Ñ–°–¢–†–ê–¶–Ü–Ø
# =======================
@dp.message(lambda m: m.text.startswith("/start"))
async def start(message: types.Message):
    args = message.get_args()  # –æ—Ç—Ä–∏–º—É—î–º–æ USERID —Ä–µ—Ñ–µ—Ä–∞–ª–∞
    user_id = message.from_user.id

    # —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—è –Ω–æ–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞
    cursor.execute("INSERT OR IGNORE INTO users (user_id) VALUES (?)", (user_id,))
    conn.commit()

    # —è–∫—â–æ —î —Ä–µ—Ñ–µ—Ä–∞–ª
    if args:
        try:
            ref_id = int(args)
            cursor.execute("UPDATE users SET referrals = referrals + 1 WHERE user_id=?", (ref_id,))
            conn.commit()
        except:
            pass

    await message.answer("–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å –≤ AquariumClickBot üê†", reply_markup=menu)

# =======================
# –ó–ê–†–û–ë–Ü–¢–ö–ò
# =======================
@dp.message(lambda m: m.text == "–ó–∞—Ä–∞–±–æ—Ç–∞—Ç—å")
async def earn(message: types.Message):
    await message.answer("–ù–∞–∂–º–∏—Ç–µ –ö–ª–∏–∫", reply_markup=earn_menu)

@dp.message(lambda m: m.text == "–ö–ª–∏–∫")
async def click(message: types.Message):
    user_id = message.from_user.id
    cursor.execute("SELECT balance, daily_earned FROM users WHERE user_id=?", (user_id,))
    data = cursor.fetchone()
    if data:
        balance, daily = data
    else:
        balance, daily = 0, 0

    if daily >= 5:
        await message.answer("–õ–∏–º–∏—Ç 5 USDT –≤ –¥–µ–Ω—å –¥–æ—Å—Ç–∏–≥–Ω—É—Ç.")
        return

    balance += 0.1
    daily += 0.1
    cursor.execute("UPDATE users SET balance=?, daily_earned=? WHERE user_id=?", (balance, daily, user_id))
    conn.commit()

    await message.answer(f"+0.1 USDT\n–í–∞—à –±–∞–ª–∞–Ω—Å: {round(balance, 2)} USDT")

# =======================
# –í–ò–í–Ü–î –ö–û–®–¢–Ü–í –ó –ü–ï–†–ï–í–Ü–†–ö–û–Æ –†–ï–§–ï–†–ê–õ–Ü–í
# =======================
@dp.message(lambda m: m.text == "–í—ã–≤–µ—Å—Ç–∏")
async def withdraw(message: types.Message):
    user_id = message.from_user.id
    cursor.execute("SELECT balance, referrals FROM users WHERE user_id=?", (user_id,))
    data = cursor.fetchone()
    if data:
        balance, referrals = data
    else:
        balance, referrals = 0, 0

    if balance < 5:
        await message.answer(f"–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–π –≤—ã–≤–æ–¥ 5 USDT\n–í–∞—à –±–∞–ª–∞–Ω—Å: {balance}")
        return

    if referrals < 20:
        await message.answer(
            f"–ß—Ç–æ–±—ã –≤—ã–≤–µ—Å—Ç–∏, –Ω—É–∂–Ω–æ –ø—Ä–∏–≥–ª–∞—Å–∏—Ç—å 20 –¥—Ä—É–∑–µ–π\n–í—ã –ø—Ä–∏–≥–ª–∞—Å–∏–ª–∏: {referrals}"
        )
        return

    # –ö–Ω–æ–ø–∫–∞ –Ω–∞ —á–µ–∫ –ø—ñ—Å–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è —É–º–æ–≤
    invoice_keyboard = InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="–ß–µ–∫ –Ω–∞ –¥–µ–Ω—å–≥–∏ USDT", url="https://trust-send.cc/invoice/INV-17114527")]
    ])
    await message.answer(
        "–ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –Ω–∏–∂–µ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–¥—É:",
        reply_markup=invoice_keyboard
    )

# =======================
# –ù–ê–ó–ê–î
# =======================
@dp.message(lambda m: m.text == "–ù–∞–∑–∞–¥")
async def back(message: types.Message):
    await message.answer("–ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é", reply_markup=menu)

# =======================
# –ó–ê–ü–£–°–ö –ë–û–¢–ê
# =======================
async def main():
    await dp.start_polling(bot)

if __name__ == "__main__":
    asyncio.run(main())
